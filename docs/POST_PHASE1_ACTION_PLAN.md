# Phase 1 å®Œæˆåçš„è¡ŒåŠ¨è®¡åˆ’

## ğŸ‰ å½“å‰çŠ¶æ€

### âœ… MLX-VLM Phase 1 å·²å®Œæˆ
- åç«¯ä¸‹è½½ API + Bridge Events
- ä¼˜å…ˆçº§é˜Ÿåˆ— + æ‡’åŠ è½½
- Splash æ¨¡å‹ä¸‹è½½é›†æˆ
- æƒé™å»¶åä¼˜åŒ–
- **æµ‹è¯•ç»“æœ**ï¼šé¦–æ¬¡ä¸‹è½½æµç¨‹å®Œå…¨æ­£å¸¸ âœ…

### ğŸ“Š æµ‹è¯•åœºæ™¯è¦†ç›–
- âœ… åˆ é™¤æ¨¡å‹æ–‡ä»¶ï¼ˆé¦–æ¬¡ä¸‹è½½ï¼‰
- âœ… æ¸…ç† Python ç¯å¢ƒï¼ˆuv syncï¼‰
- âœ… æ¸…ç†ç¼“å­˜ï¼ˆå…¨æ–°å®‰è£…ï¼‰
- âœ… è‰¯å¥½ç½‘ç»œæ¡ä»¶ï¼ˆHuggingFace ç›´è¿ï¼‰

---

## ğŸ¯ ä¸‰ä¸ªä¼˜åŒ–æ–¹å‘

### æ–¹å‘ Aï¼šå®Œæˆ MLX-VLM åŠŸèƒ½é—­ç¯
**ç›®æ ‡**ï¼šå°† MLX-VLM é›†æˆæ‰“ç£¨åˆ°ç”Ÿäº§çº§åˆ«

**ä»»åŠ¡æ¸…å•**ï¼š
1. **æ™ºèƒ½å¸è½½é€»è¾‘**ï¼ˆ2å°æ—¶ï¼‰
   - å®ç° `check_and_unload_if_unused()`
   - æŸ¥è¯¢ CapabilityAssignment è¡¨
   - 4ä¸ªèƒ½åŠ›å…¨éƒ¨åˆ‡æ¢æ—¶è‡ªåŠ¨å¸è½½
   - åœ¨èƒ½åŠ›åˆ†é… API æ·»åŠ é’©å­

2. **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼ˆ1å°æ—¶ï¼‰
   - ä¸‹è½½å¤±è´¥ + é•œåƒåˆ‡æ¢æµ‹è¯•
   - ä¼˜å…ˆçº§é˜Ÿåˆ—æµ‹è¯•ï¼ˆHIGH vs LOWï¼‰
   - æ™ºèƒ½å¸è½½æµ‹è¯•
   - æ‡’åŠ è½½ + ç©ºé—²è¶…æ—¶æµ‹è¯•

3. **åˆ é™¤æ—§ä»£ç **ï¼ˆ30åˆ†é’Ÿï¼‰
   - models_builtin.py æ—§å­è¿›ç¨‹ç®¡ç†ä»£ç 
   - models_api.py åºŸå¼ƒç«¯ç‚¹
   - UI æ—§ç»„ä»¶ï¼ˆuseBuiltinModels, BuiltinModelsTabï¼‰

**æ€»æ—¶é—´**ï¼š3.5å°æ—¶  
**æ”¶ç›Š**ï¼šMLX-VLM åŠŸèƒ½å®Œæ•´ï¼Œå¯æŠ•å…¥ç”Ÿäº§

---

### æ–¹å‘ Bï¼šä¼˜åŒ–å¯åŠ¨ä½“éªŒ
**ç›®æ ‡**ï¼šå°†é¦–æ¬¡å¯åŠ¨ç™½å±æ—¶é—´ä» 3ç§’é™ä½åˆ° <500ms

**ä»»åŠ¡æ¸…å•**ï¼š
1. **EarlySplash å®ç°**ï¼ˆ30åˆ†é’Ÿï¼‰
   - åˆ›å»ºè½»é‡çº§ EarlySplash ç»„ä»¶
   - ä¿®æ”¹ main.tsx ç«‹å³æ¸²æŸ“
   - åå°å®Œæˆåˆå§‹åŒ–åå¹³æ»‘åˆ‡æ¢

2. **æ¸…ç†è°ƒè¯•æ—¥å¿—**ï¼ˆ15åˆ†é’Ÿï¼‰
   - ç§»é™¤ Splash ä¸­çš„ console.log
   - ä¿ç•™å…³é”®é”™è¯¯æ—¥å¿—
   - ä¼˜åŒ–æ—¥å¿—æ ¼å¼

3. **æ—¥å¿—è¿ç§»åˆ° RAG è§‚å¯Ÿçª—**ï¼ˆ1å°æ—¶ï¼‰
   - å°† api-log äº‹ä»¶æ˜¾ç¤ºåœ¨ä¸»ç•Œé¢
   - ä¸ RAG æ£€ç´¢äº‹ä»¶å¹¶åˆ—æ˜¾ç¤º
   - ä¸ºåç»­å¤šé¡µç­¾è®¾è®¡åšå‡†å¤‡

**æ€»æ—¶é—´**ï¼š1.75å°æ—¶  
**æ”¶ç›Š**ï¼šç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡ï¼ˆç™½å±æ—¶é—´é™ä½ 83%ï¼‰

---

### æ–¹å‘ Cï¼šå¢å¼º RAG æ•°æ®è§‚å¯Ÿçª—
**ç›®æ ‡**ï¼šæ‰“é€ å¼ºå¤§çš„æ•°æ®è§‚å¯Ÿå’Œè°ƒè¯•å·¥å…·

**ä»»åŠ¡æ¸…å•**ï¼š
1. **å¤šé¡µç­¾æ¶æ„**ï¼ˆ1å°æ—¶ï¼‰
   - RAG æ£€ç´¢é¡µç­¾ï¼ˆå·²æœ‰ï¼‰
   - API æ—¥å¿—é¡µç­¾ï¼ˆæ–°å¢ï¼‰
   - æ¨¡å‹çŠ¶æ€é¡µç­¾ï¼ˆæ–°å¢ï¼‰
   - å‘é‡åŒ–è¿›åº¦é¡µç­¾ï¼ˆå·²æœ‰éƒ¨åˆ†ï¼‰

2. **API æ—¥å¿—é›†æˆ**ï¼ˆ1å°æ—¶ï¼‰
   - ç›‘å¬ api-log å’Œ api-error äº‹ä»¶
   - æŒ‰æ—¶é—´å€’åºæ˜¾ç¤º
   - æ”¯æŒæ—¥å¿—çº§åˆ«è¿‡æ»¤ï¼ˆINFO/WARN/ERRORï¼‰
   - æ”¯æŒå…³é”®è¯æœç´¢

3. **åŸºç¡€è¿‡æ»¤åŠŸèƒ½**ï¼ˆ1å°æ—¶ï¼‰
   - æ—¶é—´èŒƒå›´ç­›é€‰ï¼ˆæœ€è¿‘5åˆ†é’Ÿ/1å°æ—¶/å…¨éƒ¨ï¼‰
   - äº‹ä»¶ç±»å‹è¿‡æ»¤ï¼ˆå¤šé€‰ï¼‰
   - å…³é”®è¯é«˜äº®
   - æ¸…ç©ºå†å²æŒ‰é’®

**æ€»æ—¶é—´**ï¼š3å°æ—¶  
**æ”¶ç›Š**ï¼šå¼ºå¤§çš„è°ƒè¯•èƒ½åŠ›ï¼Œç”¨æˆ·å¯¹æ•°æ®æ›´æœ‰æŒæ§æ„Ÿ

---

## ğŸš€ æ¨èå®æ–½é¡ºåº

### ç¬¬ä¸€é˜¶æ®µï¼ˆä»Šå¤©ï¼Œ2å°æ—¶ï¼‰âœ¨
```
1. æ–¹å‘ B - EarlySplash å®ç°ï¼ˆ30åˆ†é’Ÿï¼‰
2. æ–¹å‘ B - æ¸…ç†è°ƒè¯•æ—¥å¿—ï¼ˆ15åˆ†é’Ÿï¼‰
3. æ–¹å‘ A - æ™ºèƒ½å¸è½½é€»è¾‘ï¼ˆ2å°æ—¶ï¼‰
```

**ç†ç”±**ï¼š
- EarlySplash å¿«é€Ÿè§æ•ˆï¼Œç”¨æˆ·ä½“éªŒç«‹å³æå‡
- æ¸…ç†è°ƒè¯•æ—¥å¿—ï¼Œè®©ä»£ç æ›´å¹²å‡€
- æ™ºèƒ½å¸è½½æ˜¯ MLX-VLM çš„æ ¸å¿ƒåŠŸèƒ½

**å½“å¤©æˆæœ**ï¼š
- âœ… ç™½å±æ—¶é—´é™ä½ 83%
- âœ… ä»£ç æ›´æ•´æ´
- âœ… MLX-VLM æ™ºèƒ½ç®¡ç†å†…å­˜

---

### ç¬¬äºŒé˜¶æ®µï¼ˆæ˜å¤©ä¸Šåˆï¼Œ1.5å°æ—¶ï¼‰âœ¨
```
1. æ–¹å‘ A - ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ1å°æ—¶ï¼‰
2. æ–¹å‘ A - åˆ é™¤æ—§ä»£ç ï¼ˆ30åˆ†é’Ÿï¼‰
```

**ç†ç”±**ï¼š
- å®Œæ•´æµ‹è¯•ç¡®ä¿åŠŸèƒ½ç¨³å®š
- åˆ é™¤æ—§ä»£ç å‡å°‘ç»´æŠ¤è´Ÿæ‹…

**é‡Œç¨‹ç¢‘**ï¼šğŸ‰ **MLX-VLM é›†æˆå®Œå…¨å®Œæˆ**

---

### ç¬¬ä¸‰é˜¶æ®µï¼ˆæ˜å¤©ä¸‹åˆ/åå¤©ï¼Œ4å°æ—¶ï¼‰âœ¨
```
1. æ–¹å‘ B - æ—¥å¿—è¿ç§»åˆ° RAG è§‚å¯Ÿçª—ï¼ˆ1å°æ—¶ï¼‰
2. æ–¹å‘ C - å¤šé¡µç­¾æ¶æ„ï¼ˆ1å°æ—¶ï¼‰
3. æ–¹å‘ C - API æ—¥å¿—é›†æˆï¼ˆ1å°æ—¶ï¼‰
4. æ–¹å‘ C - åŸºç¡€è¿‡æ»¤åŠŸèƒ½ï¼ˆ1å°æ—¶ï¼‰
```

**ç†ç”±**ï¼š
- RAG è§‚å¯Ÿçª—æ˜¯ä½ çš„ç‹¬ç‰¹è®¾è®¡
- å¤šé¡µç­¾æ¶æ„ä¸ºæœªæ¥æ‰©å±•æ‰“åŸºç¡€
- å¼ºå¤§çš„è°ƒè¯•èƒ½åŠ›

**é‡Œç¨‹ç¢‘**ï¼šğŸ‰ **æ•°æ®è§‚å¯Ÿçª—å®Œæ•´å®ç°**

---

## ğŸ“ è¯¦ç»†å®æ–½æŒ‡å—

### ä»Šå¤©ç¬¬ä¸€æ­¥ï¼šEarlySplashï¼ˆ30åˆ†é’Ÿï¼‰

#### 1. åˆ›å»º EarlySplash ç»„ä»¶
```bash
# åˆ›å»ºæ–°æ–‡ä»¶
touch tauri-app/src/EarlySplash.tsx
```

#### 2. å®ç°ä»£ç ï¼ˆè§ EARLY_SPLASH_OPTIMIZATION.mdï¼‰

#### 3. æµ‹è¯•éªŒè¯
```bash
cd tauri-app
./dev.sh
# è§‚å¯Ÿï¼šç™½å±æ—¶é—´åº”è¯¥ <500ms
```

---

### ä»Šå¤©ç¬¬äºŒæ­¥ï¼šæ¸…ç†è°ƒè¯•æ—¥å¿—ï¼ˆ15åˆ†é’Ÿï¼‰

#### è¦æ¸…ç†çš„æ–‡ä»¶
- `tauri-app/src/splash.tsx`
  - ç§»é™¤æ‰€æœ‰ `console.log('[Splash] ...')`
  - ä¿ç•™é”™è¯¯æ—¥å¿—ï¼ˆ`console.error`ï¼‰

#### å‘½ä»¤
```bash
# æŸ¥æ‰¾æ‰€æœ‰è°ƒè¯•æ—¥å¿—
grep -n "console.log.*Splash" tauri-app/src/splash.tsx

# é€ä¸ªåˆ é™¤æˆ–æ³¨é‡Šæ‰
```

---

### ä»Šå¤©ç¬¬ä¸‰æ­¥ï¼šæ™ºèƒ½å¸è½½é€»è¾‘ï¼ˆ2å°æ—¶ï¼‰

#### 1. æ•°æ®åº“æŸ¥è¯¢æ–¹æ³•
```python
# api/models_mgr.py
async def get_builtin_vlm_assignments(db: AsyncSession) -> List[CapabilityAssignment]:
    """è·å–å†…ç½®VLMæ¨¡å‹çš„4ä¸ªèƒ½åŠ›åˆ†é…"""
    result = await db.execute(
        select(CapabilityAssignment).where(
            and_(
                CapabilityAssignment.provider_type == 'builtin',
                CapabilityAssignment.capability.in_([
                    'VISION', 'TEXT', 'STRUCTURED_OUTPUT', 'TOOL_USE'
                ])
            )
        )
    )
    return result.scalars().all()
```

#### 2. å¸è½½æ£€æŸ¥æ–¹æ³•
```python
# api/models_mgr.py (MLXVLMModelManager)
async def check_and_unload_if_unused(self, db: AsyncSession):
    """æ£€æŸ¥å†…ç½®VLMæ˜¯å¦è¢«ä½¿ç”¨ï¼Œå¦‚æœå…¨éƒ¨åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å‹åˆ™è‡ªåŠ¨å¸è½½"""
    assignments = await get_builtin_vlm_assignments(db)
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•èƒ½åŠ›ä»åœ¨ä½¿ç”¨å†…ç½®VLM
    for assignment in assignments:
        if assignment.model_id == 'mlx-vlm-qwen2-vl-2b':
            logger.info(f"å†…ç½®VLMä»è¢« {assignment.capability} èƒ½åŠ›ä½¿ç”¨ï¼Œä¿æŒåŠ è½½")
            return
    
    # å…¨éƒ¨åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å‹ï¼Œå¯ä»¥å¸è½½
    logger.info("å†…ç½®VLMæ‰€æœ‰èƒ½åŠ›å‡å·²åˆ‡æ¢ï¼Œè‡ªåŠ¨å¸è½½æ¨¡å‹")
    await self.unload_model()
```

#### 3. åœ¨èƒ½åŠ›åˆ†é… API æ·»åŠ é’©å­
```python
# api/models_api.py
@router.post("/capabilities/{capability}/assign")
async def assign_capability(...):
    # ... åŸæœ‰é€»è¾‘ ...
    
    # åˆ†é…æˆåŠŸåæ£€æŸ¥æ˜¯å¦éœ€è¦å¸è½½å†…ç½®VLM
    from api.models_mgr import mlx_vlm_manager
    await mlx_vlm_manager.check_and_unload_if_unused(db)
    
    return {...}
```

---

## ğŸ§ª æµ‹è¯•æ£€æŸ¥æ¸…å•

### MLX-VLM å®Œæ•´æµ‹è¯•

#### Test 1: é¦–æ¬¡ä¸‹è½½ï¼ˆå·²é€šè¿‡ âœ…ï¼‰
```bash
rm -rf ~/Library/Application\ Support/knowledge-focus.huozhong.in/mlx-vlm
./dev.sh
```

#### Test 2: ä¸‹è½½å¤±è´¥ + é•œåƒåˆ‡æ¢
```bash
# æ¨¡æ‹Ÿ HuggingFace è¶…æ—¶
# ä¿®æ”¹ models_builtin.py é™ä½è¶…æ—¶æ—¶é—´
# è§‚å¯Ÿï¼šåº”è¯¥æ˜¾ç¤ºé•œåƒé€‰æ‹© + é‡è¯•æŒ‰é’®
```

#### Test 3: ä¼˜å…ˆçº§é˜Ÿåˆ—
```bash
# ç»ˆç«¯1ï¼šå‘é€é«˜ä¼˜å…ˆçº§è¯·æ±‚ï¼ˆèŠå¤©ï¼‰
curl -X POST http://localhost:60315/v1/chat/completions ...

# ç»ˆç«¯2ï¼šå‘é€ä½ä¼˜å…ˆçº§è¯·æ±‚ï¼ˆæ‰¹é‡ä»»åŠ¡ï¼‰
curl -X POST http://localhost:60315/models/builtin/inference ...

# è§‚å¯Ÿï¼šé«˜ä¼˜å…ˆçº§åº”è¯¥å…ˆå¤„ç†
```

#### Test 4: æ™ºèƒ½å¸è½½
```bash
# 1. æ‰“å¼€ AI Models è®¾ç½®
# 2. å°† VISION/TEXT/STRUCTURED_OUTPUT/TOOL_USE å…¨éƒ¨åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å‹
# 3. è§‚å¯Ÿæ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ° "è‡ªåŠ¨å¸è½½æ¨¡å‹" æ¶ˆæ¯
# 4. æŸ¥çœ‹å†…å­˜ï¼šåº”è¯¥é‡Šæ”¾ ~4GB
```

#### Test 5: æ‡’åŠ è½½ + ç©ºé—²è¶…æ—¶
```bash
# 1. å¯åŠ¨ Appï¼ˆæ¨¡å‹æœªåŠ è½½ï¼‰
# 2. å‘é€ä¸€æ¡å¸¦å›¾ç‰‡çš„æ¶ˆæ¯ï¼ˆè§¦å‘åŠ è½½ï¼‰
# 3. ç­‰å¾… 60 ç§’ä¸ä½¿ç”¨
# 4. è§‚å¯Ÿæ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ° "ç©ºé—²è¶…æ—¶ï¼Œå¸è½½æ¨¡å‹" æ¶ˆæ¯
```

---

## ğŸ“Š é¢„æœŸæˆæœå¯¹æ¯”

| æŒ‡æ ‡ | Phase 0 | Phase 1 å®Œæˆå |
|------|---------|---------------|
| é¦–æ¬¡å¯åŠ¨ç™½å±æ—¶é—´ | 3000ms | <500ms â¬†ï¸ 83% |
| æ¨¡å‹ä¸‹è½½æµç¨‹ | æ‰‹åŠ¨/å¤æ‚ | è‡ªåŠ¨/æµç•… âœ… |
| å†…å­˜ç®¡ç† | æ‰‹åŠ¨ | æ™ºèƒ½å¸è½½ âœ… |
| è°ƒè¯•èƒ½åŠ› | ç»ˆç«¯æ—¥å¿— | å¯è§†åŒ–è§‚å¯Ÿçª— âœ… |
| ä»£ç è´¨é‡ | æ—§ä»£ç æ··æ‚ | æ•´æ´ âœ… |
| ç”¨æˆ·ä½“éªŒ | 6/10 | 9/10 â¬†ï¸ 50% |

---

## ğŸ’¡ åç»­å¯é€‰æ–¹å‘

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰
- [ ] æ·»åŠ æ¨¡å‹ä¸‹è½½å–æ¶ˆåŠŸèƒ½
- [ ] ä¼˜åŒ–ä¸‹è½½è¿›åº¦æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºé€Ÿåº¦ã€é¢„è®¡æ—¶é—´ï¼‰
- [ ] æ·»åŠ ç¦»çº¿æ¨¡å¼ï¼ˆè·³è¿‡æ¨¡å‹ä¸‹è½½ï¼‰

### ä¸­æœŸï¼ˆä¸‹å‘¨ï¼‰
- [ ] æ”¯æŒå…¶ä»–å†…ç½®æ¨¡å‹ï¼ˆé€‰æ‹©ä¸åŒçš„ VLMï¼‰
- [ ] æ¨¡å‹ç‰ˆæœ¬ç®¡ç†ï¼ˆæ£€æŸ¥æ›´æ–°ï¼‰
- [ ] å¤šæ¨¡å‹å¹¶è¡ŒåŠ è½½

### é•¿æœŸï¼ˆæœªæ¥ï¼‰
- [ ] æ¨¡å‹çƒ­åˆ‡æ¢ï¼ˆæ— éœ€å¸è½½ï¼‰
- [ ] æ¨¡å‹æ€§èƒ½ç›‘æ§ä»ªè¡¨ç›˜
- [ ] A/B æµ‹è¯•ä¸åŒæ¨¡å‹æ•ˆæœ

---

## ğŸ¯ ç«‹å³å¼€å§‹

**ç°åœ¨å°±å¯ä»¥å¼€å§‹ç¬¬ä¸€æ­¥ï¼šEarlySplash å®ç°ï¼**

æˆ‘å¯ä»¥å¸®ä½ ï¼š
1. åˆ›å»º `EarlySplash.tsx` æ–‡ä»¶
2. ä¿®æ”¹ `main.tsx` å®ç°ç«‹å³æ¸²æŸ“
3. æµ‹è¯•éªŒè¯ç™½å±æ—¶é—´ä¼˜åŒ–

**ä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ** ğŸš€
